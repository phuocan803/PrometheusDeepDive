#To federate data, you will need to build a new Prometheus server with the following settings:
#Install Prometheus on the Federal Prometheus Server
#Log in to your new Federal Prometheus Server.
#Create a user, group, and directories for Prometheus:
sudo useradd -M -r -s /bin/false prometheus
sudo mkdir /etc/prometheus /var/lib/prometheus

#Download and extract the pre-compiled binaries:

# 1. Tải Prometheus v2.52.0
wget https://github.com/prometheus/prometheus/releases/download/v2.52.0/prometheus-2.52.0.linux-amd64.tar.gz

# 2. Giải nén
tar xzf prometheus-2.52.0.linux-amd64.tar.gz

# 3. Di chuyển nhị phân
sudo cp prometheus-2.52.0.linux-amd64/{prometheus,promtool} /usr/local/bin/

# 4. Tạo thư mục
sudo mkdir -p /etc/prometheus /var/lib/prometheus

# 5. Di chuyển cấu hình và giao diện
sudo cp -r prometheus-2.52.0.linux-amd64/{consoles,console_libraries} /etc/prometheus/
sudo cp prometheus-2.52.0.linux-amd64/prometheus.yml /etc/prometheus/prometheus.yml

# 6. Tạo user Prometheus
sudo useradd -M -r -s /bin/false prometheus

# 7. Phân quyền
sudo chown prometheus:prometheus /usr/local/bin/{prometheus,promtool}
sudo chown -R prometheus:prometheus /etc/prometheus
sudo chown prometheus:prometheus /var/lib/prometheus

# 8. Chạy thử
prometheus --config.file=/etc/prometheus/prometheus.yml

sudo nano /etc/prometheus/prometheus.yml
sudo killall -HUP prometheus
sudo systemctl restart prometheus
sudo apt install curl
curl -s localhost:9090/api/v1/status/config | grep scrape_interval
sudo nano /etc/systemd/system/prometheus.service

[Unit]
Description=Prometheus Time Series Collection and Processing Server
Wants=network-online.target
After=network-online.target
[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/usr/local/bin/prometheus \
 --config.file /etc/prometheus/prometheus.yml \
 --storage.tsdb.path /var/lib/prometheus/ \
 --web.console.templates=/etc/prometheus/consoles \
 --web.console.libraries=/etc/prometheus/console_libraries
[Install]
WantedBy=multi-user.target


#Add Configuration to Federate Data from Another Prometheus Server
sudo nano /etc/prometheus/prometheus.yml

scrape_configs:
 ...
 - job_name: 'federate'
 scrape_interval: 15s
 honor_labels: true
 metrics_path: '/federate'
 params:
 'match[]':
 - '{job!~"prometheus"}'
 static_configs:
 - targets:
 - '<PROMETHEUS_SERVER_1_PRIVATE_IP>:9090'


sudo systemctl enable prometheus
sudo systemctl start prometheus

#copy all prometheus Configuration form server 1 to server 2
#Log in to your first Prometheus server.
#Edit your Prometheus config to change any localhost references that might not work properly on the new server:
sudo nano /etc/prometheus/prometheus.yml

#Change references to localhost except for the target of the prometheus job to the private IP address of your first Prometheus server.
#Copy prometheus.yml to Prometheus Server 2:
scp /etc/prometheus/prometheus.yml
cloud_user@<PROMETHEUS_SERVER_2_PRIVATE_IP>:/home/cloud_user

#Copy your rules files to Prometheus Server 2:
scp /etc/prometheus/rules/*
cloud_user@<PROMETHEUS_SERVER_2_PRIVATE_IP>:/home/cloud_user

#Log in to Prometheus Server 2 and move prometheus.yml to the appropriate location:
sudo mv ~/prometheus.yml /etc/prometheus/prometheus.yml

#Create the rules directory, and then move the rules file to the appropriate location.
sudo mkdir -p /etc/prometheus/rules
sudo mv ~/*.yml /etc/prometheus/rules

#Start the Second Prometheus Instance
sudo systemctl enable prometheus
sudo systemctl start prometheus


