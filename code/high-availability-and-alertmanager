
#Log in to the new sever.
#Create a user and group for Alertmanager

sudo useradd -m -r -s /bin/false alertmanager

#Download and install the Alertmanager binaries, move the files into the appropriate locations, and set ownership:
wget https://github.com/prometheus/alertmanager/releases/download/v0.27.0/alertmanager-0.27.0.linux-amd64.tar.gz
tar xvfz alertmanager-0.27.0.linux-amd64.tar.gz

sudo cp alertmanager-0.27.0.linux-amd64/{alertmanager,amtool} /usr/local/bin
sudo chown alertmanager:alertmanager /usr/local/bin/{alertmanager,amtool}
sudo mkdir -p /etc/alertmanager
sudo cp alertmanager-0.27.0.linux-amd64/alertmanager.yml /etc/alertmanager
sudo chown -R alertmanager:alertmanager /etc/alertmanager


#Create a data directory for Alertmanager
sudo mkdir -p /var/lib/alertmanager
sudo chown alertmanager:alertmanager /var/lib/alertmanager

#Create a configuration file for amtool
sudo mkdir -p /etc/amtool
sudo nano /etc/amtool/config.yml

#Enter the following content in the amtool config file
alertmanager.url: http://localhost:9093

#Create a systemd unit file for Alertmanager
sudo nano /etc/systemd/system/alertmanager.service

[Unit]
Description=Prometheus Alertmanager
Wants=network-online.target
After=network-online.target

[Service]
User=alertmanager
Group=alertmanager
Type=simple
ExecStart=/usr/local/bin/alertmanager --config.file=/etc/alertmanager/alertmanager.yml --storage.path=/var/lib/alertmanager --cluster.peer=192.168.60.135:9094
Restart=on-failure

[Install]
WantedBy=multi-user.target



#Start and enable the alertmanager service:
sudo systemctl enable alertmanager
sudo systemctl start alertmanager

#Verify the service is running and you can reach it
sudo systemctl status alertmanager
curl localhost:9093

#Access Alertmanager in a web browser at http://localhost:9093

#Verify amtool is able to connect to Alertmanager and retrieve the current configuration
amtool config show


#Log in to Alertmanager server (node1)
#Edit the alertmanager unit file:
sudo nano /etc/systemd/system/alertmanager.service

#Add a --cluster.peer flag to the Execstart section.
--cluster.peer=<ip node3>:9094

#Reload and restart the alertmanager service
sudo systemctl daemon-reload
sudo systemctl restart alertmanager

#to verify your cluster is working
sudo systemctl status alertmanager

#config prometheus to connect to both alretmanager instances
#log in to the prometheus server

sudo nano /etc/prometheus/prometheus.yml

#add the new alertmanager to the list of alertmanager targets
alerting:
    alertmanager:
    - static_configs:
     - targets: ["localhost:9093","ip node 3:9093"]

#reload and restart prometheus
sudo systemctl daemon-reload
sudo systemctl restart prometheus


  
